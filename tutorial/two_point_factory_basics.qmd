---
title: "Factory Basics: Constructing TwoPoint Objects"
format: html
---

{{< include _functions.qmd >}}

## Purpose of this Document

This tutorial explains how to use the **[[likelihood|TwoPointFactory]]** to construct **[[likelihood|TwoPoint]]** objects from metadata and optional data. This is the core mechanism for building likelihood objects, regardless of whether your metadata came from generators or SACC files.

For conceptual background, see [Two-Point Framework](two_point_framework.qmd).

## The Role of TwoPointFactory

The **[[likelihood|TwoPointFactory]]** automates the construction of **[[likelihood|TwoPoint]]** likelihood objects. It:

1. **Inspects metadata** to determine what types of measurements are involved
2. **Delegates to source factories** (e.g., [[likelihood.weak_lensing|WeakLensingFactory]], [[likelihood.number_counts|NumberCountsFactory]]) based on measurement types
3. **Applies modeling choices** including systematics and nuisance parameters
4. **Produces ready-to-use TwoPoint objects** that can compute theory predictions or evaluate likelihoods

### Input: Metadata ± Data

The factory accepts either:

- **Layout only** ([[metadata_types|TwoPointHarmonic]] or [[metadata_types|TwoPointReal]]) → produces theory-only TwoPoint objects
- **Measurement** ([[data_types|TwoPointMeasurement]]) → produces TwoPoint objects with both data and theory

The metadata can come from two sources:

1. **Generated** ([Two-Point Generators](two_point_generators.qmd)): Programmatically created using Firecrown's generators
2. **Extracted** ([Loading SACC Data](two_point_sacc_loading.qmd)): Read from existing SACC files

Regardless of source, the factory treats the metadata identically.

### Output: TwoPoint Objects

Each produced [[likelihood|TwoPoint]] object:
- Contains all modeling assumptions (systematics, bias models, etc.)
- Can compute theoretical predictions via `compute_theory_vector()`
- If created from measurement data, can contribute to likelihood evaluation
- Is a subclass of [[likelihood|Statistic]] and can be combined into a [[likelihood|Likelihood]]

## Source Factory Mapping

The [[likelihood|TwoPointFactory]] automatically maps measurement types to appropriate source factories:

- [[metadata_types|Galaxies.COUNTS]] → [[likelihood.number_counts|NumberCountsFactory]]
- [[metadata_types|Galaxies.SHEAR_E]], [[metadata_types|Galaxies.SHEAR_T]], etc. → [[likelihood.weak_lensing|WeakLensingFactory]]

### Multiple TypeSource Support

The factory can hold multiple instances of the same source factory type, each associated with a different [[metadata_types|TypeSource]]. This enables distinct modeling choices for subpopulations:

```python
# Example: Different systematics for red vs. blue galaxies
factory = TwoPointFactory(
    correlation_space=TwoPointCorrelationSpace.HARMONIC,
    number_counts_factories=[
        NumberCountsFactory(type_source="red", ...),
        NumberCountsFactory(type_source="blue", ...),
    ]
)
```

By default, both bins and factories use [[metadata_types|TypeSource.DEFAULT]], so simple analyses don't need to worry about this feature.

## Metadata Structure Overview

Before using the factory, it's helpful to understand Firecrown's four-layer metadata hierarchy:

1. **Bin Descriptors** (e.g., [[metadata_types|InferredGalaxyZDist]])
   - Properties of individual observables (redshift distributions, tracer types)
   - Shared across components for consistency

2. **Bin Pairs** ([[metadata_types|TwoPointXY]])
   - Cross-correlations between two bins
   - Ensures paired bin compatibility

3. **Data Layouts** ([[metadata_types|TwoPointHarmonic]] or [[metadata_types|TwoPointReal]])
   - Measurement structure: harmonic space ($C_\ell$) or real space ($\xi(\theta)$)
   - Metadata only — no observational data

4. **Measurement Containers** ([[data_types|TwoPointMeasurement]])
   - Combines layout with observed/simulated data

See [Two-Point Framework](two_point_framework.qmd) for detailed explanation.

## Where Metadata Comes From

There are two primary workflows for obtaining the metadata that the factory needs:

### 1. Generate from Scratch
[Two-Point Generators](two_point_generators.qmd) shows how to:
- Create [[metadata_types|InferredGalaxyZDist]] bins programmatically
- Generate LSST-SRD redshift distributions
- Define systematics factories
- Build metadata layouts

Use this when creating forecasts or simulations.

### 2. Extract from SACC Files
[Loading SACC Data](two_point_sacc_loading.qmd) shows how to:
- Extract metadata and data from SACC files
- Use full extraction (recommended) or legacy indices-only approach
- Validate extracted data consistency

Use this when working with real observations or pre-existing data files.

## Next Steps

Once you understand factory basics:

- **Work with SACC files**: [Loading SACC Data](two_point_sacc_loading.qmd)
- **Generate from scratch**: [Two-Point Generators](two_point_generators.qmd)
- **Apply scale cuts** (optional): [Scale Cuts and Filtering](two_point_scale_cuts.qmd)
- **Control integration**: [Integration Methods](two_point_integration.qmd)
